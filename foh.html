<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FOH</title>
<style>
body {
  background:#111;
  color:white;
  font-family:Arial, sans-serif;
  text-align:center;
  padding:40px;
}

.num {
  font-size:90px;
  color:#00ff99;
  margin:20px 0;
}

.status {
  font-size:24px;
  margin-bottom:20px;
}

select, textarea {
  width:80%;
  font-size:18px;
  padding:10px;
  margin-top:10px;
}

button {
  font-size:26px;
  padding:15px 35px;
  margin-top:20px;
  border:none;
  border-radius:10px;
  background:#00ff99;
  cursor:pointer;
}

.undo {
  background:#ffcc00;
  color:black;
}

.addons {
  margin-top:20px;
  font-size:20px;
}
</style>
</head>
<body>

<h1>FOH</h1>

<div class="status" id="status">Status: ‚Äì</div>
<div class="num" id="num">‚Äì</div>

<select id="dish"></select>

<br><br>

<div class="addons">
  <label>
    <input type="checkbox" id="addon-chimi">
    üåø Chimichurri
  </label>
</div>

<br>

<label>
  <input type="checkbox" id="allergy">
  ‚ö†Ô∏è ALLERGI
</label>

<br><br>

<textarea id="note" placeholder="Uten l√∏k / uten saus / annet‚Ä¶"></textarea>

<br>
<button id="orderBtn" onclick="newOrder()">NY ORDRE</button>
<br>
<button class="undo" onclick="undoLast()">‚Ü©Ô∏è UNDO</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
var firebaseConfig = {
  apiKey: "AIzaSyBpCwh0JIuJphlEyCQTxhDOIdGm9fP5cg4",
  databaseURL: "https://the-shit-3bfd8-default-rtdb.europe-west1.firebasedatabase.app"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let menu = {};
let lastOrderId = null;
let lastDishId = null;
let busy = false;

db.ref("lastNumber").on("value", snap => {
  const val = snap.val();
  document.getElementById("num").innerText =
    typeof val === "number" ? val : "‚Äì";
});

db.ref("menu").on("value", snap => {
  const sel = document.getElementById("dish");
  sel.innerHTML = "";
  menu = {};

  snap.forEach(child => {
    const d = child.val();
    const left = d.max - d.sold;
    menu[child.key] = d;

    let status = "üü¢ Tilgjengelig";
    if (left <= 0) status = "üî¥ Utsolgt";
    else if (left <= 3) status = "üü° F√• igjen";

    const opt = document.createElement("option");
    opt.value = child.key;
    opt.text = `${d.name} ‚Äì ${status}`;
    opt.disabled = left <= 0;
    sel.appendChild(opt);
  });
});

function newOrder() {
  if (busy) return;
  busy = true;
  document.getElementById("orderBtn").disabled = true;

  const dishId = document.getElementById("dish").value;
  if (!dishId) return resetBusy();

  db.ref("menu/" + dishId).transaction(dish => {
    if (!dish || dish.sold >= dish.max) return;
    dish.sold += 1;
    return dish;
  }, (err, committed, snap) => {
    if (!committed) {
      alert("‚ùå Utsolgt");
      return resetBusy();
    }

    db.ref("lastNumber").transaction(n => (n || 0) + 1, (e, ok, numSnap) => {
      if (!ok) return resetBusy();

      const addons = {};
      if (document.getElementById("addon-chimi").checked) {
        addons.chimichurri = true;
      }

      db.ref("orders/" + numSnap.val()).set({
        dish: snap.val().name,
        allergy: document.getElementById("allergy").checked,
        note: document.getElementById("note").value,
        addons: addons,
        time: Date.now()
      });

      lastOrderId = numSnap.val();
      lastDishId = dishId;

      document.getElementById("allergy").checked = false;
      document.getElementById("note").value = "";
      document.getElementById("addon-chimi").checked = false;

      resetBusy();
    });
  });
}

function undoLast() {
  if (lastOrderId === null) return;

  db.ref("orders/" + lastOrderId).remove();
  db.ref("menu/" + lastDishId + "/sold").transaction(n => Math.max(n - 1, 0));
  db.ref("lastNumber").transaction(n => n === lastOrderId ? n - 1 : n);

  lastOrderId = null;
  lastDishId = null;
}

function resetBusy() {
  busy = false;
  document.getElementById("orderBtn").disabled = false;
}

db.ref("orders").on("value", snap => {
  const count = snap.numChildren();
  let s = "üü¢ Rolig";
  if (count >= 4) s = "üü° K√∏";
  if (count >= 7) s = "üî¥ Rush";
  document.getElementById("status").innerText = "Status: " + s;
});
</script>

</body>
</html>
