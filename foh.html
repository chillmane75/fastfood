<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FOH</title>
<style>
body {
  background:#111;
  color:white;
  font-family:Arial, sans-serif;
  text-align:center;
  padding:40px;
}

.num {
  font-size:90px;
  color:#00ff99;
  margin:20px 0;
}

.status {
  font-size:24px;
  margin-bottom:20px;
}

select, textarea {
  width:80%;
  font-size:18px;
  padding:10px;
  margin-top:10px;
}

button {
  font-size:26px;
  padding:15px 35px;
  margin-top:20px;
  border:none;
  border-radius:10px;
  background:#00ff99;
  cursor:pointer;
}

.undo {
  background:#ffcc00;
  color:black;
}

.addons {
  margin-top:20px;
  font-size:20px;
  text-align:left;
  display:inline-block;
}
</style>
</head>
<body>

<h1>FOH</h1>

<div class="status" id="status">Status: ‚Äì</div>
<div class="num" id="num">‚Äì</div>

<select id="dish"></select>

<div class="addons" id="addons"></div>

<br>

<label>
  <input type="checkbox" id="allergy">
  ‚ö†Ô∏è ALLERGI
</label>

<br><br>

<textarea id="note" placeholder="Uten l√∏k / uten saus / annet‚Ä¶"></textarea>

<br>
<button id="orderBtn" onclick="newOrder()">NY ORDRE</button>
<br>
<button class="undo" onclick="undoLast()">‚Ü©Ô∏è UNDO</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBpCwh0JIuJphlEyCQTxhDOIdGm9fP5cg4",
  databaseURL: "https://the-shit-3bfd8-default-rtdb.europe-west1.firebasedatabase.app"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let menu = {};
let addons = {};
let lastOrderId = null;
let lastDishId = null;
let busy = false;

/* üî¢ NUMMER */
db.ref("lastNumber").on("value", snap => {
  document.getElementById("num").innerText =
    typeof snap.val() === "number" ? snap.val() : "‚Äì";
});

/* üçî MENY */
db.ref("menu").on("value", snap => {
  const sel = document.getElementById("dish");
  sel.innerHTML = "";
  menu = {};

  snap.forEach(child => {
    const d = child.val();
    const left = d.max - d.sold;
    if (left <= 0) return;

    menu[child.key] = d;
    const opt = document.createElement("option");
    opt.value = child.key;
    opt.text = d.name;
    sel.appendChild(opt);
  });
});

/* ‚ûï ADD-ONS (DYNAMISK) */
db.ref("addons").on("value", snap => {
  const div = document.getElementById("addons");
  div.innerHTML = "<strong>Add-ons</strong><br>";
  addons = {};

  if (!snap.exists()) {
    div.style.display = "none";
    return;
  }

  div.style.display = "block";

  snap.forEach(child => {
    const a = child.val();
    addons[child.key] = a;

    const label = document.createElement("label");
    label.innerHTML = `
      <input type="checkbox" data-addon="${child.key}">
      üåø ${a.name}
    `;
    div.appendChild(label);
    div.appendChild(document.createElement("br"));
  });
});

/* üÜï NY ORDRE */
function newOrder() {
  if (busy) return;
  busy = true;
  orderBtn.disabled = true;

  const dishId = dish.value;
  if (!dishId) return resetBusy();

  db.ref("menu/" + dishId).transaction(d => {
    if (!d || d.sold >= d.max) return;
    d.sold++;
    return d;
  }, (err, ok, snap) => {
    if (!ok) return resetBusy();

    db.ref("lastNumber").transaction(n => (n || 0) + 1, (e, c, numSnap) => {
      if (!c) return resetBusy();

      const selectedAddons = {};
      document
        .querySelectorAll("[data-addon]:checked")
        .forEach(el => selectedAddons[el.dataset.addon] = true);

      db.ref("orders/" + numSnap.val()).set({
        dish: snap.val().name,
        allergy: allergy.checked,
        note: note.value,
        addons: selectedAddons,
        time: Date.now()
      });

      lastOrderId = numSnap.val();
      lastDishId = dishId;

      allergy.checked = false;
      note.value = "";
      document
        .querySelectorAll("[data-addon]")
        .forEach(el => el.checked = false);

      resetBusy();
    });
  });
}

/* ‚Ü©Ô∏è UNDO */
function undoLast() {
  if (!lastOrderId) return;

  db.ref("orders/" + lastOrderId).remove();
  db.ref("menu/" + lastDishId + "/sold")
    .transaction(n => Math.max(n - 1, 0));

  db.ref("lastNumber")
    .transaction(n => n === lastOrderId ? n - 1 : n);

  lastOrderId = null;
  lastDishId = null;
}

function resetBusy() {
  busy = false;
  orderBtn.disabled = false;
}

/* üìä STATUS */
db.ref("orders").on("value", snap => {
  const c = snap.numChildren();
  let s = "üü¢ Rolig";
  if (c >= 4) s = "üü° K√∏";
  if (c >= 7) s = "üî¥ Rush";
  status.innerText = "Status: " + s;
});
</script>

</body>
</html>
