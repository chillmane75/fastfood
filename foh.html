<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FOH</title>
<style>
body {
  background:#111;
  color:white;
  font-family:Arial;
  text-align:center;
  padding:40px;
}

.num { font-size:90px; color:#00ff99; margin:20px 0; }
.status { font-size:24px; margin-bottom:20px; }

select, textarea {
  width:80%;
  font-size:20px;
  padding:12px;
  margin-top:10px;
}

button {
  font-size:28px;
  padding:18px 40px;
  margin-top:20px;
  border:none;
  border-radius:12px;
  background:#00ff99;
  cursor:pointer;
}

.undo { background:#ffcc00; color:black; }

.addons {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
  gap:16px;
  max-width:700px;
  margin:25px auto;
}

.addon-btn {
  padding:22px;
  border-radius:16px;
  font-size:22px;
  background:#222;
  border:3px solid #333;
  cursor:pointer;
}

.addon-btn.active {
  background:#00ff99;
  color:black;
  border-color:#00ff99;
}

.addon-btn.disabled {
  background:#333;
  color:#777;
  border-color:#444;
  cursor:not-allowed;
}
</style>
</head>
<body>

<h1>FOH</h1>

<div class="status" id="status">Status: –</div>
<div class="num" id="num">–</div>

<select id="dish"></select>

<div class="addons" id="addons"></div>

<label><input type="checkbox" id="allergy"> ⚠️ ALLERGI</label>

<br><br>
<textarea id="note" placeholder="Uten løk / uten saus / annet…"></textarea>

<br>
<button id="orderBtn" onclick="newOrder()">NY ORDRE</button>
<br>
<button class="undo" onclick="undoLast()">↩️ UNDO</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyBpCwh0JIuJphlEyCQTxhDOIdGm9fP5cg4",
  databaseURL:"https://the-shit-3bfd8-default-rtdb.europe-west1.firebasedatabase.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let selectedAddons = {};
let lastOrderId=null, lastDishId=null, busy=false;

/* NUMMER */
db.ref("lastNumber").on("value", s=>{
  num.innerText = typeof s.val()==="number"?s.val():"–";
});

/* MENY */
db.ref("menu").on("value", snap=>{
  dish.innerHTML="";
  snap.forEach(c=>{
    if(c.val().sold < c.val().max){
      const o=document.createElement("option");
      o.value=c.key; o.text=c.val().name;
      dish.appendChild(o);
    }
  });
});

/* ADD-ONS */
db.ref("addons").on("value", snap=>{
  addons.innerHTML="";
  selectedAddons={};

  snap.forEach(c=>{
    const a=c.val();
    const left=a.max-a.sold;
    const b=document.createElement("div");

    b.className="addon-btn"+(left<=0?" disabled":"");
    b.innerText=a.name+(left<=0?" (UTSOLGT)":"");

    if(left>0){
      b.onclick=()=>{
        b.classList.toggle("active");
        selectedAddons[c.key]=b.classList.contains("active");
      };
    }

    addons.appendChild(b);
  });
});

/* NY ORDRE */
function newOrder(){
  if(busy) return;
  busy=true; orderBtn.disabled=true;
  const dishId=dish.value;

  db.ref("menu/"+dishId).transaction(d=>{
    if(!d||d.sold>=d.max) return;
    d.sold++; return d;
  },(e,ok,snap)=>{
    if(!ok) return reset();

    db.ref("lastNumber").transaction(n=>(n||0)+1,(e,c,nr)=>{
      const addonsOut={};
      Object.keys(selectedAddons).forEach(k=>{
        if(selectedAddons[k]) addonsOut[k]=true;
      });

      // øk sold på add-ons
      Object.keys(addonsOut).forEach(id=>{
        db.ref("addons/"+id+"/sold")
          .transaction(n=>n+1);
      });

      db.ref("orders/"+nr.val()).set({
        dish:snap.val().name,
        allergy:allergy.checked,
        note:note.value,
        addons:addonsOut,
        time:Date.now()
      });

      lastOrderId=nr.val();
      lastDishId=dishId;

      document.querySelectorAll(".addon-btn")
        .forEach(b=>b.classList.remove("active"));
      selectedAddons={};
      allergy.checked=false;
      note.value="";
      reset();
    });
  });
}

function undoLast(){
  if(!lastOrderId) return;
  db.ref("orders/"+lastOrderId).once("value", s=>{
    const o=s.val();
    if(o?.addons){
      Object.keys(o.addons).forEach(id=>{
        db.ref("addons/"+id+"/sold")
          .transaction(n=>Math.max(n-1,0));
      });
    }
  });
  db.ref("orders/"+lastOrderId).remove();
  db.ref("menu/"+lastDishId+"/sold")
    .transaction(n=>Math.max(n-1,0));
  db.ref("lastNumber")
    .transaction(n=>n===lastOrderId?n-1:n);
  lastOrderId=null; lastDishId=null;
}

function reset(){ busy=false; orderBtn.disabled=false; }
</script>

</body>
</html>
