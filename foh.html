<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FOH</title>
<style>
body {
  background:#111;
  color:white;
  font-family:Arial, sans-serif;
  text-align:center;
  padding:40px;
}

.num {
  font-size:90px;
  color:#00ff99;
  margin:20px 0;
}

.status {
  font-size:24px;
  margin-bottom:20px;
}

select, textarea {
  width:80%;
  font-size:18px;
  padding:10px;
  margin-top:10px;
}

button {
  font-size:26px;
  padding:15px 35px;
  margin-top:20px;
  border:none;
  border-radius:10px;
  background:#00ff99;
  cursor:pointer;
}

.undo {
  background:#ffcc00;
  color:black;
}
</style>
</head>
<body>

<h1>FOH</h1>

<div class="status" id="status">Status: ‚Äì</div>
<div class="num" id="num">‚Äì</div>

<select id="dish"></select>

<br><br>

<label>
  <input type="checkbox" id="allergy">
  ‚ö†Ô∏è ALLERGI
</label>

<br><br>

<textarea id="note" placeholder="Uten l√∏k / uten saus / annet‚Ä¶"></textarea>

<br>
<button onclick="newOrder()">NY ORDRE</button>
<br>
<button class="undo" onclick="undoLast()">‚Ü©Ô∏è UNDO</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* üî• FIREBASE */
var firebaseConfig = {
  apiKey: "AIzaSyBpCwh0JIuJphlEyCQTxhDOIdGm9fP5cg4",
  databaseURL: "https://the-shit-3bfd8-default-rtdb.europe-west1.firebasedatabase.app"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* üî¢ STATE */
let menu = {};
let lastOrderId = null;
let lastDishId = null;

/* üî¢ ALLTID SYNK NUMMER FRA FIREBASE */
db.ref("lastNumber").on("value", snap => {
  const val = snap.val();
  document.getElementById("num").innerText =
    typeof val === "number" ? val : "‚Äì";
});

/* üçî HENT MENY */
db.ref("menu").on("value", snap => {
  const sel = document.getElementById("dish");
  sel.innerHTML = "";
  menu = {};

  snap.forEach(child => {
    const d = child.val();
    const left = d.max - d.sold;
    menu[child.key] = d;

    let status = "üü¢ Tilgjengelig";
    if (left <= 0) status = "üî¥ Utsolgt";
    else if (left <= 3) status = "üü° F√• igjen";

    const opt = document.createElement("option");
    opt.value = child.key;
    opt.text = `${d.name} ‚Äì ${status}`;
    opt.disabled = left <= 0;
    sel.appendChild(opt);
  });

  if (sel.options.length > 0 && !sel.value) {
    sel.selectedIndex = 0;
  }
});

/* üÜï NY ORDRE */
function newOrder() {
  const dishSelect = document.getElementById("dish");
  const dishId = dishSelect.value;
  const dish = menu[dishId];

  if (!dish) {
    alert("Ingen rett valgt");
    return;
  }

  db.ref("lastNumber").transaction(n => (n || 0) + 1, (err, ok, snap) => {
    if (!ok || !snap.exists()) {
      alert("Kunne ikke opprette ordre");
      return;
    }

    const num = Number(snap.val());

    db.ref("orders/" + num).set({
      dish: dish.name,
      allergy: document.getElementById("allergy").checked,
      note: document.getElementById("note").value,
      time: Date.now()
    });

    db.ref("menu/" + dishId + "/sold")
      .transaction(n => (n || 0) + 1);

    lastOrderId = num;
    lastDishId = dishId;

    document.getElementById("allergy").checked = false;
    document.getElementById("note").value = "";
  });
}

/* ‚Ü©Ô∏è UNDO ‚Äì EKTE ROLLBACK */
function undoLast() {
  if (lastOrderId === null || lastDishId === null) {
    alert("Ingen ordre √• angre");
    return;
  }

  const orderId = Number(lastOrderId);

  // 1Ô∏è‚É£ Slett ordren
  db.ref("orders/" + orderId).remove();

  // 2Ô∏è‚É£ Rull tilbake solgt
  db.ref("menu/" + lastDishId + "/sold")
    .transaction(n => Math.max((n || 1) - 1, 0));

  // 3Ô∏è‚É£ RULL TILBAKE NUMMERET KUN HVIS DET ER SISTE
  db.ref("lastNumber").transaction(n => {
    if (Number(n) === orderId) {
      return n - 1;
    }
    return n;
  });

  lastOrderId = null;
  lastDishId = null;
}

/* üìä STATUS */
db.ref("orders").on("value", snap => {
  const count = snap.numChildren();
  let s = "üü¢ Rolig";
  if (count >= 4) s = "üü° K√∏";
  if (count >= 7) s = "üî¥ Rush";
  document.getElementById("status").innerText = "Status: " + s;
});
</script>

</body>
</html>
