<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kj√∏kken</title>
<style>
body {
  background:#000;
  color:white;
  font-family:Arial;
  text-align:center;
  padding:30px;
}

.order {
  padding:20px;
  margin:12px auto;
  border-radius:12px;
  font-size:26px;
  max-width:700px;
  text-align:left;
}

.green{background:#1e3d2f;}
.yellow{background:#4a4a1e;}
.red{background:#4a1e1e;}

.allergy { color:#ff4444; font-weight:bold; }
.note { font-size:20px; }

.addons {
  margin-top:8px;
  padding:8px;
  background:#000;
  border-radius:8px;
  font-size:22px;
  color:#00ff99;
}
</style>
</head>
<body>

<h1>KJ√òKKEN</h1>
<div id="orders"></div>

<!-- üîî LYD: BRUKER EKSISTERENDE order-up.mp3 -->
<audio id="newOrderSound" preload="auto">
  <source src="order-up.mp3" type="audio/mpeg">
</audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBpCwh0JIuJphlEyCQTxhDOIdGm9fP5cg4",
  databaseURL:"https://the-shit-3bfd8-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

const ordersDiv = document.getElementById("orders");
const sound = document.getElementById("newOrderSound");

let addonMap = {};
let seenOrders = new Set();
let initialLoadDone = false;

/* üîé ADD-ONS */
db.ref("addons").on("value", snap => {
  addonMap = {};
  if (!snap.exists()) return;
  snap.forEach(c => addonMap[c.key] = c.val().name);
});

/* üìã ORDRE + LYDLOGIKK */
db.ref("orders").on("value", snap => {
  ordersDiv.innerHTML = "";

  const now = Date.now();
  const currentIds = new Set();

  if (snap.exists()) {
    snap.forEach(child => {
      const id = child.key;
      const o = child.val();
      currentIds.add(id);

      // üîî Kun lyd p√• NY ordre (ikke ved refresh)
      if (initialLoadDone && !seenOrders.has(id)) {
        try {
          sound.pause();
          sound.currentTime = 0;
          sound.play();
        } catch (e) {}
      }

      const age = now - o.time;
      let c = "green";
      if (age > 240000) c = "red";
      else if (age > 120000) c = "yellow";

      let addonsHtml = "";
      if (o.addons) {
        const list = Object.keys(o.addons)
          .map(aid => addonMap[aid])
          .filter(Boolean);
        if (list.length) {
          addonsHtml = `<div class="addons">‚ûï ${list.join(" ‚Ä¢ ")}</div>`;
        }
      }

      const el = document.createElement("div");
      el.className = `order ${c}`;
      el.innerHTML = `
        <strong>ORDRE ${id}</strong>
        <div style="font-size:24px;margin-top:4px;">üçî ${o.dish}</div>
        ${o.allergy ? '<div class="allergy">‚ö†Ô∏è ALLERGI</div>' : ''}
        ${addonsHtml}
        ${o.note ? `<div class="note">üìù ${o.note}</div>` : ''}
        <button onclick="done(${id})">FERDIG</button>
      `;
      ordersDiv.appendChild(el);
    });
  }

  seenOrders = currentIds;
  initialLoadDone = true;
});

function done(num){
  db.ref("orders/"+num).once("value", s=>{
    if(!s.exists()) return;
    db.ref("readyOrders/"+num).set({...s.val(), readyTime:Date.now()});
    db.ref("orders/"+num).remove();
  });
}
</script>

</body>
</html>
